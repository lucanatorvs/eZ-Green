#include <Arduino.h>
#include <Wire.h>
#include <Adafruit_TLC59711.h>

const int duty_cycle_16bit[360][2] = {{-61393, 12302},{52284, 12304},{48037, 12312},{45788, 12325},{43638, 12343},{40986, 12366},{35189, 12395},{31765, 12428},{30235, 12467},{29166, 12510},{28318, 12559},{27601, 12613},{26972, 12671},{26408, 12735},{25893, 12803},{25416, 12876},{24971, 12954},{24552, 13037},{24155, 13125},{23778, 13217},{23417, 13313},{23071, 13414},{22737, 13520},{22416, 13629},{22105, 13744},{21803, 13862},{21510, 13985},{21226, 14111},{20948, 14242},{20678, 14377},{20414, 14516},{20156, 14658},{19903, 14804},{19656, 14955},{19414, 15109},{19177, 15266},{18945, 15427},{18717, 15592},{18493, 15760},{18274, 15932},{18058, 16108},{17847, 16287},{17639, 16469},{17435, 16655},{17235, 16845},{17038, 17038},{16845, 17235},{16655, 17435},{16469, 17639},{16287, 17847},{16108, 18058},{15932, 18274},{15760, 18493},{15592, 18717},{15427, 18945},{15266, 19177},{15109, 19414},{14955, 19656},{14804, 19903},{14658, 20156},{14516, 20414},{14377, 20678},{14242, 20948},{14111, 21226},{13985, 21510},{13862, 21803},{13744, 22105},{13629, 22416},{13520, 22737},{13414, 23071},{13313, 23417},{13217, 23778},{13125, 24155},{13037, 24552},{12954, 24971},{12876, 25416},{12803, 25893},{12735, 26408},{12671, 26972},{12613, 27601},{12559, 28318},{12510, 29166},{12467, 30235},{12428, 31765},{12395, 35189},{12366, 40986},{12343, 43638},{12325, 45788},{12312, 48037},{12304, 52284},{12302, 61393},{12304, -52284},{12312, -48037},{12325, -45788},{12343, -43638},{12366, -40986},{12395, -35189},{12428, -31765},{12467, -30235},{12510, -29166},{12559, -28318},{12613, -27601},{12671, -26972},{12735, -26408},{12803, -25893},{12876, -25416},{12954, -24971},{13037, -24552},{13125, -24155},{13217, -23778},{13313, -23417},{13414, -23071},{13520, -22737},{13629, -22416},{13744, -22105},{13862, -21803},{13985, -21510},{14111, -21226},{14242, -20948},{14377, -20678},{14516, -20414},{14658, -20156},{14804, -19903},{14955, -19656},{15109, -19414},{15266, -19177},{15427, -18945},{15592, -18717},{15760, -18493},{15932, -18274},{16108, -18058},{16287, -17847},{16469, -17639},{16655, -17435},{16845, -17235},{17038, -17038},{17235, -16845},{17435, -16655},{17639, -16469},{17847, -16287},{18058, -16108},{18274, -15932},{18493, -15760},{18717, -15592},{18945, -15427},{19177, -15266},{19414, -15109},{19656, -14955},{19903, -14804},{20156, -14658},{20414, -14516},{20678, -14377},{20948, -14242},{21226, -14111},{21510, -13985},{21803, -13862},{22105, -13744},{22416, -13629},{22737, -13520},{23071, -13414},{23417, -13313},{23778, -13217},{24155, -13125},{24552, -13037},{24971, -12954},{25416, -12876},{25893, -12803},{26408, -12735},{26972, -12671},{27601, -12613},{28318, -12559},{29166, -12510},{30235, -12467},{31765, -12428},{35189, -12395},{40986, -12366},{43638, -12343},{45788, -12325},{48037, -12312},{52284, -12304},{61393, -12302},{-52284, -12304},{-48037, -12312},{-45788, -12325},{-43638, -12343},{-40986, -12366},{-35189, -12395},{-31765, -12428},{-30235, -12467},{-29166, -12510},{-28318, -12559},{-27601, -12613},{-26972, -12671},{-26408, -12735},{-25893, -12803},{-25416, -12876},{-24971, -12954},{-24552, -13037},{-24155, -13125},{-23778, -13217},{-23417, -13313},{-23071, -13414},{-22737, -13520},{-22416, -13629},{-22105, -13744},{-21803, -13862},{-21510, -13985},{-21226, -14111},{-20948, -14242},{-20678, -14377},{-20414, -14516},{-20156, -14658},{-19903, -14804},{-19656, -14955},{-19414, -15109},{-19177, -15266},{-18945, -15427},{-18717, -15592},{-18493, -15760},{-18274, -15932},{-18058, -16108},{-17847, -16287},{-17639, -16469},{-17435, -16655},{-17235, -16845},{-17038, -17038},{-16845, -17235},{-16655, -17435},{-16469, -17639},{-16287, -17847},{-16108, -18058},{-15932, -18274},{-15760, -18493},{-15592, -18717},{-15427, -18945},{-15266, -19177},{-15109, -19414},{-14955, -19656},{-14804, -19903},{-14658, -20156},{-14516, -20414},{-14377, -20678},{-14242, -20948},{-14111, -21226},{-13985, -21510},{-13862, -21803},{-13744, -22105},{-13629, -22416},{-13520, -22737},{-13414, -23071},{-13313, -23417},{-13217, -23778},{-13125, -24155},{-13037, -24552},{-12954, -24971},{-12876, -25416},{-12803, -25893},{-12735, -26408},{-12671, -26972},{-12613, -27601},{-12559, -28318},{-12510, -29166},{-12467, -30235},{-12428, -31765},{-12395, -35189},{-12366, -40986},{-12343, -43638},{-12325, -45788},{-12312, -48037},{-12304, -52284},{-12302, -61393},{-12304, 52284},{-12312, 48037},{-12325, 45788},{-12343, 43638},{-12366, 40986},{-12395, 35189},{-12428, 31765},{-12467, 30235},{-12510, 29166},{-12559, 28318},{-12613, 27601},{-12671, 26972},{-12735, 26408},{-12803, 25893},{-12876, 25416},{-12954, 24971},{-13037, 24552},{-13125, 24155},{-13217, 23778},{-13313, 23417},{-13414, 23071},{-13520, 22737},{-13629, 22416},{-13744, 22105},{-13862, 21803},{-13985, 21510},{-14111, 21226},{-14242, 20948},{-14377, 20678},{-14516, 20414},{-14658, 20156},{-14804, 19903},{-14955, 19656},{-15109, 19414},{-15266, 19177},{-15427, 18945},{-15592, 18717},{-15760, 18493},{-15932, 18274},{-16108, 18058},{-16287, 17847},{-16469, 17639},{-16655, 17435},{-16845, 17235},{-17038, 17038},{-17235, 16845},{-17435, 16655},{-17639, 16469},{-17847, 16287},{-18058, 16108},{-18274, 15932},{-18493, 15760},{-18717, 15592},{-18945, 15427},{-19177, 15266},{-19414, 15109},{-19656, 14955},{-19903, 14804},{-20156, 14658},{-20414, 14516},{-20678, 14377},{-20948, 14242},{-21226, 14111},{-21510, 13985},{-21803, 13862},{-22105, 13744},{-22416, 13629},{-22737, 13520},{-23071, 13414},{-23417, 13313},{-23778, 13217},{-24155, 13125},{-24552, 13037},{-24971, 12954},{-25416, 12876},{-25893, 12803},{-26408, 12735},{-26972, 12671},{-27601, 12613},{-28318, 12559},{-29166, 12510},{-30235, 12467},{-31765, 12428},{-35189, 12395},{-40986, 12366},{-43638, 12343},{-45788, 12325},{-48037, 12312},{-52284, 12304},};

const int NUM_TLC = 1;
Adafruit_TLC59711 tlc = Adafruit_TLC59711(NUM_TLC, 11, 12);

#define STBY     10  // Standby inverted for all gauges

class Gauge {
public:
    Gauge(uint8_t PH_sin, uint8_t PH_cos, uint8_t EN_sin, uint8_t EN_cos)
      : PH_sin(PH_sin), PH_cos(PH_cos), EN_sin(EN_sin), EN_cos(EN_cos) {
        pinMode(PH_sin, OUTPUT);
        pinMode(PH_cos, OUTPUT);
    }

    void setCoilCurrent(int angle) {
        angle = (360 - angle) % 360;
        int sin = duty_cycle_16bit[angle][0];
        int cos = duty_cycle_16bit[angle][1];
        
        digitalWrite(PH_sin, (sin < 0) ? LOW : HIGH);
        digitalWrite(PH_cos, (cos < 0) ? LOW : HIGH);
        
        tlc.setPWM(EN_sin, abs(sin));
        tlc.setPWM(EN_cos, abs(cos));
        tlc.write();
    }

private:
    uint8_t PH_sin, PH_cos, EN_sin, EN_cos;
};

// Instantiate the gauges
Gauge speedometer(0, 1, 5, 4);  // Speedometer: PH_sin, PH_cos, EN_sin, EN_cos
Gauge tachometer(5, 4, 3, 2);  // Tachometer: PH_sin, PH_cos, EN_sin, EN_cos
Gauge dynamometer(3, 2, 1, 0); // Dynamometer: PH_sin, PH_cos, EN_sin, EN_cos
Gauge chargeometer(9, 8, 6, 7); // Chargeometer: PH_sin, PH_cos, EN_sin, EN_cos
Gauge thermometer(7, 6, 8, 9); // Thermometer: PH_sin, PH_cos, EN_sin, EN_cosw

void setup() {
    pinMode(LED_BUILTIN, OUTPUT);
    pinMode(STBY, OUTPUT);
    Serial.begin(9600);
    tlc.begin();

    // Initialize channels 0 to 9 to 100% duty cycle (full-on)
    for (uint8_t channel = 0; channel <= 9; channel++) {
        tlc.setPWM(channel, 65535);
    }

    // Initialize channels 10 and 11 to 0 (off)
    tlc.setPWM(10, 65535);
    tlc.setPWM(11, 65535);
    
    tlc.write();
}

void loop() {
    if (Serial.available() > 0) {
        String inputString = Serial.readStringUntil('\n');
        inputString.trim();

        if (inputString.startsWith("STBY:")) {
            bool standbyState = inputString.substring(5).toInt();
            digitalWrite(STBY, standbyState ? HIGH : LOW);
        } else {
            String gaugeName = inputString.substring(0, inputString.indexOf(':'));
            int angle = inputString.substring(inputString.indexOf(':') + 1).toInt();

            if (gaugeName == "Speedometer") {
                speedometer.setCoilCurrent(angle);
            } else if (gaugeName == "Tachometer") {
                tachometer.setCoilCurrent(angle);
            } else if (gaugeName == "Dynamometer") {
                dynamometer.setCoilCurrent(angle);
            } else if (gaugeName == "Chargeometer") {
                chargeometer.setCoilCurrent(angle);
            } else if (gaugeName == "Thermometer") {
                thermometer.setCoilCurrent(angle);
            }
        }
    }
}
